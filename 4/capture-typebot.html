<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Capturar Typebot Completo</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #output { background: #f5f5f5; padding: 15px; margin: 20px 0; max-height: 500px; overflow: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Capturando Typebot...</h1>
    <button onclick="downloadAllData()">üì• Download Todos os Dados</button>
    <button onclick="clearData()">üóëÔ∏è Limpar</button>
    <div id="status">Aguardando requisi√ß√µes...</div>
    <div id="output"></div>

    <script>
        const allData = {
            requests: [],
            responses: [],
            typebot: null
        };

        // Intercepta XMLHttpRequest
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function(method, url) {
            this._url = url;
            this._method = method;
            return originalXHROpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function(data) {
            this.addEventListener('load', function() {
                if (this._url && this._url.includes('railway.app')) {
                    try {
                        const responseData = JSON.parse(this.responseText);
                        allData.responses.push({
                            url: this._url,
                            method: this._method,
                            status: this.status,
                            data: responseData
                        });
                        updateDisplay();
                    } catch(e) {}
                }
            });
            return originalXHRSend.apply(this, arguments);
        };

        // Intercepta Fetch
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : args[0].url;
            
            console.log('üîç Fetch:', url);
            
            const response = await originalFetch.apply(this, args);
            
            if (url && url.includes('railway.app')) {
                const clonedResponse = response.clone();
                try {
                    const contentType = response.headers.get('content-type');
                    let data;
                    
                    if (contentType && contentType.includes('application/json')) {
                        data = await clonedResponse.json();
                    } else {
                        data = await clonedResponse.text();
                    }
                    
                    allData.requests.push({
                        url: url,
                        method: args[1]?.method || 'GET',
                        data: data,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log('‚úÖ Dados capturados:', data);
                    updateDisplay();
                } catch(e) {
                    console.error('‚ùå Erro ao capturar:', e);
                }
            }
            
            return response;
        };

        function updateDisplay() {
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            
            status.innerHTML = `‚úÖ Capturados: ${allData.requests.length} requisi√ß√µes`;
            output.innerHTML = '<pre>' + JSON.stringify(allData, null, 2) + '</pre>';
        }

        function downloadAllData() {
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'typebot-completo-' + Date.now() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Dados baixados!');
        }

        function clearData() {
            allData.requests = [];
            allData.responses = [];
            allData.typebot = null;
            updateDisplay();
        }

        // Carrega o Typebot
        window.addEventListener('DOMContentLoaded', () => {
            const script = document.createElement('script');
            script.type = 'module';
            script.src = 'https://cdn.jsdelivr.net/npm/@typebot.io/js@0.3/dist/web.js';
            document.head.appendChild(script);
            
            script.onload = () => {
                const typebotElement = document.createElement('typebot-standard');
                typebotElement.setAttribute('typebot', 'rodando-v-3-apinovo-m4n9uej');
                typebotElement.setAttribute('api-host', 'https://viewer-production-9742.up.railway.app');
                typebotElement.style.width = '100%';
                typebotElement.style.height = '600px';
                typebotElement.style.display = 'block';
                typebotElement.style.marginTop = '20px';
                document.body.appendChild(typebotElement);
                
                console.log('üöÄ Typebot carregado, aguardando dados...');
            };
        });
    </script>
</body>
</html>
